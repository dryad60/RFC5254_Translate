# 4. 发送初始化请求
------
在请求/应答模式下，一个端点想要发送初始化请求，则它必须(1) 收集候选地址 (2) 排序候选地址 (3)排除重复候选 (4) 选择默认候选 (5) 规划并发送SDP请求。
除了5的其余步骤在完全和简化实现下有不同的实现。

### 4.1 完全实现

### 4.1.1 收集候选

端点在通讯发生之前会手机候选地址, 通过接口层调用或者一个初始化会话的请求来开始。每一个候选地址都是一个通讯地址，具有类型和基础地址。
四类候选地址:本地,服务反射,对端反射和中继候选。服务器发射地址通过STUN或TURN服务来生成, 中继则通过TURN服务来获取。对端发射地址在ICE后面的连接性检查阶段
来获得。基础地址是指使用一个候选地址时，消息需要从哪个本地地址来发送。

### 4.1.1.1 本地候选

第一步就是获取本地候选。本地候选地址是通过在本地的网络接口(物理/虚拟/VPN...)IP地址接口上绑定一个端口(一般是临时端口)来取得.
对于UDP媒体流, 端点需要通过绑定一个UDP端口到特定IP的方式，将媒体流的每个组件在本机的每个IP地址上都分配一个本地候选。每个候选一般都与一个特定的组件相关联，而
组件都有一个ID分配到候选上，叫组件ID.例如RTP媒体流, RTP的组件ID是1，RTCP的组件ID是2.如果一个端点要使用RTCP，就需要分配一个候选给它。如果一个端点要同时使
用RTP和RTCP，那么它应该分配 2K 个主机候选在它的K个IP地址上。
本地候选的基础地址是它本身。

### 4.1.1.2 服务反射候选/中继候选

端点“应该”获取服务反射候选和中继候选。“应该”是因为有时通讯端点位于封闭网络下，不能连接到外网环境下的STUN和TURN服务器。这样的情况下，ICE完全实现将会应用
到那些具有多重初始地址的端点，使用它们的本地候选。TURN服务器的代价比较高，并且ICE也只会在两个通讯端点都位于NAT后面，进行地址和端口依赖映射时使用。于是，一些
部署者会考虑这种使用比较边缘化，而选择不部署TURN服务器。如果一个端点不想使用服务反射和中继候选，推荐做法是保留这个功能，通过配置禁用，这样可以在将来要启用时
简单的通过配置就可改变。当同时请求服务反射和中继候选时，应该使用TURN服务器，而如果只使用服务反射地址，则应使用STUN服务器。

端点接下来配对本地候选和对应的STUN/TURN服务器，这可以通过配置或者某种方式的发现。推荐方式STUN/TURN使用域名来配置，DNS解析获取实际信息。

本SPEC只讨论只有一个STUN/TURN服务器时的应用。如果有多个(例如从DNS查询里返回多个),则一个端点需要对一个会话下的所有的候选使用同一个服务器。这会提高ICE的表现。
端点得到了一组本地候选和对应STUN/TURN服务器的配对记录，从中选择一对，然后发起一个绑定或分配请求到服务器，通过对应的本地候选地址。绑定请求到STUN服务器是不验证
的，响应里的任何ALTERNATE-SERVER属性都会被忽略。端点需要支持向绑定请求的向后兼容模式（定义在RFC5389）。分配请求则是需要验证的，方式是客户端持有的长期的凭据。

在一定毫秒之后, 端点可以生成新的STUN/TURN请求。可以是刚刚的请求的重试，或者是对新的STUN/TURN地址对发起。这个过程不要太频繁，在16小结有对间隔时间和重试时间
的指导说明。

端点会收到绑定或分配请求的回应。一个成功的分配请求会回复端点一个服务反射候选地址(从映射地址获取)和一个中继候选地址在XOR-RELAYED-ADDRESS属性中。如果分配请求
因为服务器资源不够的原因被拒绝，端点应该重新发送一个绑定请求去获取服务反射候选。绑定请求只会分配给请求者一个服务反射候选地址(从映射地址获取). 服务反射地址的基础
地址是绑定/分配请求发送出去的那个本地候选地址。中继候选地址的基础地址则是它自己。如果中继候选地址和一个本地候选地址相同(在极少情况会发生), 这个中继候选应该被抛
弃。

### 4.1.1.3 计算基础设定

最后,需要为每个候选地址生成基础设定。基础设定是一个在会话范围内的标志。在以下条件下，两个候选必须具有同样的基础设定标志:
+ 具有相同的类型 (主机候选/服务器反射/中继/对端反射)
+ 基础地址相同
+ 对于服务反射地址和中继地址，生成它们的STUN或TURN服务器是同一个IP地址
+ 在同样的协议下获取(TCP/UDP...)

同样的，两个候选必须具有不同的基础设定，如果它们具有不同的类型，不同的基础地址IP，从不同的STUN/TURN服务器生成，亦或是通讯协议不一致。

### 4.1.1.4 保持候选有效

服务反射候选和中继候选从服务器分配后，需要保证她们存活有效直到ICE处理过程完成。对于从绑定请求生成的服务反射候选，这种绑定需要通过发送额外的绑定请求到服务
器进行保持存活。使用刷新操作可以刷新所有的候选分配.（定义在RFC5766)。而刷新请求也会刷新服务反射候选。


### 4.1.2 排序候选

排序过程就是给所有候选地址分配一个优先级。每个候选地址的优先级应该是一个在1~2^31-1之间的正整数。这个优先级会在ICE处理的连接检查和候选关联中被使用。
端点应该遵循4.1.2.1小节中定义的准则来计算优先级，使用4.1.2.2中的指引来选择参数。如果一个端点选择了其他算法，ICE会化更长的时间来协调端点之间的连接。

### 4.1.2.1 建议的准则

在本准则下，首先从每类候选地址选择一个类型偏好参照, 而且如果端点是多重地址的，则也从这些IP地址中选择一个作为地址的偏好参照。这两个偏好一起用来计算优先级。
计算公式:
   优先级 = （2^24) * (类型偏好) + (2^8) * (本地地址偏好) + (2^0) * (256 - 组件ID);

类型偏好的值应该在0~126之间，从来区分候选地址的类型。而126是最高优先级，0是最低。设置为0则表示此类型的候选地址将会是最末选择的类型。
对于同样类型的候选地址，她们的类型偏好值必须相同，而不同类型的则必须不同。而对端反射候选的优先级应该比服务反射候选的优先级高。要注意通过4.1.1小结中的方式
获取的候选地址都不会是对端候选，对端候选是在ICE后续的连接性检查中获取到的。

本地地址偏好值应该在0~65535之间。它是表示在主机有多个本地IP时，候选地址是从哪一个IP上获取的。65535是最高优先，0最低，在只有一个IP时，应该设置为65535。
通常来说，如果在一个媒体流的一个组件下有同类型的多个候选地址，那么它们的本地偏好值一定是不同的。在本SPEC，这种情况只发生在端点是多重本地地址时。
如果端点的多重初始地址是由于它是双栈的，那么优先IP地址的本地偏好值应该设置为相同的(RFC 3484);

组件ID是候选地址的组件的ID值，必须设置为1～256之间。

### 4.1.2.2 选取偏好类型和偏好地址的指引
