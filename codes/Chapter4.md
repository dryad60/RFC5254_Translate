# 4. 发送初始化请求
------
在请求/应答模式下，一个端点想要发送初始化请求，则它必须(1) 收集候选地址 (2) 排序候选地址 (3)排除重复候选 (4) 选择默认候选 (5) 规划并发送SDP请求。
除了5的其余步骤在完全和简化实现下有不同的实现。

### 4.1 完全实现

### 4.1.1 收集候选

端点在通讯发生之前会手机候选地址, 通过接口层调用或者一个初始化会话的请求来开始。每一个候选地址都是一个通讯地址，具有类型和基础地址。
四类候选地址:本地,服务反射,对端反射和中继候选。服务器发射地址通过STUN或TURN服务来生成, 中继则通过TURN服务来获取。对端发射地址在ICE后面的连接性检查阶段
来获得。基础地址是指使用一个候选地址时，消息需要从哪个本地地址来发送。

### 4.1.1.1 本地候选

第一步就是获取本地候选。本地候选地址是通过在本地的网络接口(物理/虚拟/VPN...)IP地址接口上绑定一个端口(一般是临时端口)来取得.
对于UDP媒体流, 端点需要通过绑定一个UDP端口到特定IP的方式，将媒体流的每个组件在本机的每个IP地址上都分配一个本地候选。每个候选一般都与一个特定的组件相关联，而
组件都有一个ID分配到候选上，叫组件ID.例如RTP媒体流, RTP的组件ID是1，RTCP的组件ID是2.如果一个端点要使用RTCP，就需要分配一个候选给它。如果一个端点要同时使
用RTP和RTCP，那么它应该分配 2K 个主机候选在它的K个IP地址上。
本地候选的基础地址是它本身。

### 4.1.1.2 服务反射候选/中继候选

端点“应该”获取服务反射候选和中继候选。“应该”是因为有时通讯端点位于封闭网络下，不能连接到外网环境下的STUN和TURN服务器。这样的情况下，ICE完全实现将会应用
到那些具有多重初始地址的端点，使用它们的本地候选。TURN服务器的代价比较高，并且ICE也只会在两个通讯端点都位于NAT后面，进行地址和端口依赖映射时使用。于是，一些
部署者会考虑这种使用比较边缘化，而选择不部署TURN服务器。如果一个端点不想使用服务反射和中继候选，推荐做法是保留这个功能，通过配置禁用，这样可以在将来要启用时
简单的通过配置就可改变。当同时请求服务反射和中继候选时，应该使用TURN服务器，而如果只使用服务反射地址，则应使用STUN服务器。

端点接下来配对本地候选和对应的STUN/TURN服务器，这可以通过配置或者某种方式的发现。推荐方式STUN/TURN使用域名来配置，DNS解析获取实际信息。

本SPEC只讨论只有一个STUN/TURN服务器时的应用。如果有多个(例如从DNS查询里返回多个),则一个端点需要对一个会话下的所有的候选使用同一个服务器。这会提高ICE的表现。
端点得到了一组本地候选和对应STUN/TURN服务器的配对记录，从中选择一对，然后发起一个绑定或分配请求到服务器，通过对应的本地候选地址。绑定请求到STUN服务器是不验证
的，响应里的任何ALTERNATE-SERVER属性都会被忽略。端点需要支持向绑定请求的向后兼容模式（定义在RFC5389）。分配请求则是需要验证的，方式是客户端持有的长期的凭据。

在一定毫秒之后, 端点可以生成新的STUN/TURN请求。可以是刚刚的请求的重试，或者是对新的STUN/TURN地址对发起。这个过程不要太频繁，在16小结有对间隔时间和重试时间
的指导说明。

端点会收到绑定或分配请求的回应。一个成功的分配请求会回复端点一个服务反射候选地址(从映射地址获取)和一个中继候选地址在XOR-RELAYED-ADDRESS属性中。如果分配请求
因为服务器资源不够的原因被拒绝，端点应该重新发送一个绑定请求去获取服务反射候选。绑定请求只会分配给请求者一个服务反射候选地址(从映射地址获取). 服务反射地址的基础
地址是绑定/分配请求发送出去的那个本地候选地址。中继候选地址的基础地址则是它自己。如果中继候选地址和一个本地候选地址相同(在极少情况会发生), 这个中继候选应该被抛
弃。

### 4.1.1.3 计算基础设定

最后,需要为每个候选地址生成基础设定。基础设定是一个在会话范围内的标志。在以下条件下，两个候选必须具有同样的基础设定标志:
+ 具有相同的类型 (主机候选/服务器反射/中继/对端反射)
+ 基础地址相同
+ 对于服务反射地址和中继地址，生成它们的STUN或TURN服务器是同一个IP地址
+ 在同样的协议下获取(TCP/UDP...)

同样的，两个候选必须具有不同的基础设定，如果它们具有不同的类型，不同的基础地址IP，从不同的STUN/TURN服务器生成，亦或是通讯协议不一致。

### 4.1.1.4 保持候选有效

服务反射候选和中继候选从服务器分配后，需要保证她们存活有效直到ICE处理过程完成。对于从绑定请求生成的服务反射候选，这种绑定需要通过发送额外的绑定请求到服务
器进行保持存活。使用刷新操作可以刷新所有的候选分配.（定义在RFC5766)。而刷新请求也会刷新服务反射候选。


### 4.1.2 排序候选

排序过程就是给所有候选地址分配一个优先级。每个候选地址的优先级应该是一个在1~2^31-1之间的正整数。这个优先级会在ICE处理的连接检查和候选关联中被使用。
端点应该遵循4.1.2.1小节中定义的准则来计算优先级，使用4.1.2.2中的指引来选择参数。如果一个端点选择了其他算法，ICE会化更长的时间来协调端点之间的连接。

### 4.1.2.1 建议的准则

在本准则下，首先从每类候选地址选择一个类型偏好参照, 而且如果端点是多重地址的，则也从这些IP地址中选择一个作为地址的偏好参照。这两个偏好一起用来计算优先级。
计算公式:
   优先级 = （2^24) * (类型偏好) + (2^8) * (本地地址偏好) + (2^0) * (256 - 组件ID);

类型偏好的值应该在0~126之间，从来区分候选地址的类型。而126是最高优先级，0是最低。设置为0则表示此类型的候选地址将会是最末选择的类型。
对于同样类型的候选地址，她们的类型偏好值必须相同，而不同类型的则必须不同。而对端反射候选的优先级应该比服务反射候选的优先级高。要注意通过4.1.1小结中的方式
获取的候选地址都不会是对端候选，对端候选是在ICE后续的连接性检查中获取到的。

本地地址偏好值应该在0~65535之间。它是表示在主机有多个本地IP时，候选地址是从哪一个IP上获取的。65535是最高优先，0最低，在只有一个IP时，应该设置为65535。
通常来说，如果在一个媒体流的一个组件下有同类型的多个候选地址，那么它们的本地偏好值一定是不同的。在本SPEC，这种情况只发生在端点是多重本地地址时。
如果端点的多重初始地址是由于它是双栈的，那么优先IP地址的本地偏好值应该设置为相同的(RFC 3484);

组件ID是候选地址的组件的ID值，必须设置为1～256之间。

### 4.1.2.2 选取偏好类型和偏好地址的指引

当选择类型偏好和地址偏好时，一个重要的准则就是考虑媒体中介的影响，比如TURN服务器或VPN服务器或者NAT。当一个数据发往候选地址时，它会首先经过媒体中介再被接收到。
中继候选是一种包含了媒体中介的候选类型，另外一个是从VPN接口获取的本地候选。当数据传输需要穿过一个媒体中间层，会在传输和响应增加延迟。也会增加丢包率，因为路由器
跨越次数的增加。这样也会增加服务的消耗，数据需要在媒体中介上出入/转发。如果这些条件比较重要，那么中继候选应该比本地候选的优先级低。建议的设定是本地候选偏好值是126，
服务反射候选是100，对端反射候选110，而中继候选为0.更进一步的，如果端点是多重地址初始化的，本地地址偏好上，从VPN上获取的本地候选优先级应该也是0.

另外一个选择偏好的准则则是IP地址协议族。 ICE可以在IPv4和v6上工作, 因此ICE提供了一个机制，可以在双栈的端点上优先使用IPv6进行通讯，但当v6失败时会退回到v4进行
工作。这也会帮助那些具有v6私有地址和v6转v4(6to4 address)地址的主机。在这样的情况下，优先级排序应该是:v6地址,v6转v4地址，和v4地址.这样就允许端点首先
立即使用v6私有地址通信, 但如果对方不支持v6连接，则回退使用v6转v4地址进行连接。

选择偏好的另一个准则就是安全。如果用户是一个远程工作者，他同时连接了工作网络和家庭网络。那么他应该更希望他工作语音通过VPN路由而传输在工作网络内，而与其他非工作
相关的用户通讯时使用家庭网络。这时，VPN地址对于其他地址应该具有更高的优先级。

还有一个准则就是网络拓扑考虑。这个对那些需要使用媒体中介的候选地址最有意义。如果一个端点通过事先配置或动态发现，可以判断那些媒体中介服务器跟自己的距离，则可以分配
更高的优先级到那些离自己更近更快的中间服务器所分配的候选地址。

### 4.1.3 消除重复的候选

接下来，要去掉重复的候选地址。两个候选地址是重复，如果它们的传输地址相同并且基础地址也相同。要注意也有可能候选的传输地址一样但是基础地址不同，这样的候选不是重复的。
最常见的，端点的服务反射地址和本地候选地址可能是相同的，在这个端点不位于任何NAT之后时。端点需要将重复的候选给予很低的优先级。

### 4.1.4 选择默认的候选

一个候选成为默认候选，是指它成为了一个从非ICE节点传输的媒体流的目标，这个目标也成为默认目的地。如果端点的默认候选，没有在和ICE端点通讯的过程中由ICE算法而选中，
那么会要求在ICE处理过程结束后发送更新请求/响应来补充SDP, 以保证默认目的地和ICE选择的候选一致。如果ICE过程刚好选中了默认候选，则不再需要更新消息。

端点要求给每个在使用的媒体流的每一个组件选择一个默认候选地址。媒体流真在使用的标志是它的端口不为0(在RFC3264中0用来拒绝媒体流)。因此如果媒体流被标记为
a=inactive(RFC4566)或者占用带宽为0,也是可能正在被使用中。

选择默认候选建议的方式是根据这些候选地址和通讯对方的连接可能性。所以建议默认候选地址是中继候选, 服务反射候选，最后才是本地候选。


### 4.2 简化实现的要求

简化实现仅仅初始化本地候选。简化实现时，对每个媒体流的每个组件，只会分配0个或1个IPv4候选。它会分配0个或更多的IPv6候选，但是对于每个IPv6地址也只会分配一个。
由于只会分配一个IPv4候选，对于有多个v4地址的端点，需要选择一个最佳的v4地址。端点如果是双栈的，那么建议是分配一个v4候选和一个全局的v6地址。在简化实现下，主机
无法实现动态选择候选地址。以此有多个候选地址是不合适的，因为主机只会做一次连接性检查，来查询一个地址是否可用或使用其他候选地址。

每个组件含有一个组件ID。例如RTP类的媒体流，RTP的组件ID是1，RTCP是2.如果端点使用了RTCP，则必须为RTCP分配候选。

每个候选地址具有基础设定。从不同地址获取的候选，基础设定必须不同，反之则必须相同。

每个IP地址有一个增长的整数标识。媒体流的每个候选地址需要具有不同的优先级标识。优先级应设定为：
priority = (2^24) * 126 + (2^8) * (IP precedence) + (2^0) * (256 - component ID)

如果端点只有IPv4地址，则IP标识应设置为65535. 如果IP地址是v6或双栈的，那么IP标识应该遵循 RFC 3484。

接下来，端点为每个组件选择一个默认候选。如果主机是IPv4的，则主机为每个组件只会分配一个候选，这个候选也是默认候选。如果是IPv6或双栈的时候，选择默认就是一个本地
策略。应该选择那个最适合被对端使用的候选。例如IPv6端点，则应该是那个全局IPv6地址。双栈的话，建议是IPv4地址。


### 4.3 SDP编码

简化和完全实现的SDP编码方式是不同的。

端点的媒体流会包含一个m行。端点的在SDP中的媒体流顺序是和ICE有关的。ICE会首先对m行中的第一个媒体流发起连接，接下来这个媒体流会首先发送数据。所以端点应该把最重要
的媒体流放在前面。

每个媒体流的候选会有候选属性。 15小节 会展示构造属性的细节。这个属性包含了候选的IP地址，端口和传输协议，和那些对端工作需要的属性：优先级，基础设定和组件ID。
属性也会包括类型和关联通讯地址，这些在调试检查和其他功能很有用的设置。

端点间的STUN连接检查需要验证，遵循STUN的短时凭证机制(RFC5389)。这个机制使用客户端和服务器之间的用户和密钥来进行认证，ICE下，通过请求/响应消息来交换。
这个凭据的用户名部分，由ICE端点的用户名连接而成，通过分号分割。而凭据的密钥部分，则会用来计算收到的消息的完整性。一般用户名和密钥会在ice-ufrag和ice-pwd属性
中分别进行交换。为了进一步增加安全性，用户名也会在媒体流上用来加解密消息。附件 B.4 描述了这种做法。

如果端点是使用简化实现，它需要在SDP的session-level属性标识"a=ice-lite"。完全实现则不需要包含这个属性。

默认候选在SDP中填写为数据的默认目的地。对于RTP流，就分别把IP地址和端口写到SDP的c和m行中。如果端点在初始化RTCP，它需要编码RTCP候选而使用a=rtcp属性(RFC 3605)。
如果RTCP没有使用，端点需要通知b=RS:0和b=RR:0(RFC 3556)。

当与非ICE端点工作时，默认目的地的传输地址需要像候选一样呈现在一个或多个a=candidate行中。

ICE提供了扩展允许使用一个请求或应答来包含一系列信息来表明端点使用的ICE扩展。如果端点使用了扩展，它必须在ice-options属性表现扩展的token。
下面是一个包含ICE属性的SDP示例消息，
v=0
o=jdoe 2890844526 2890842807 IN IP4 10.0.1.1
s=
c=IN IP4 192.0.2.3
t=0 0
a=ice-pwd:asd88fgpdd777uzjYhagZg
a=ice-ufrag:8hhY
m=audio 45664 RTP/AVP 0
b=RS:0
b=RR:0
a=rtpmap:0 PCMU/8000
a=candidate:1 1 UDP 2130706431 10.0.1.1 8998 typ host
a=candidate:2 1 UDP 1694498815 192.0.2.3 45664 typ srflx raddr
10.0.1.1 rport 8998

当端点发送了请求或响应消息，它需要同时准备好在每个候选上接收STUN消息或者媒体数据包。如 11.1小节讨论所示，媒体数据可以在请求/应答的默认地址消息之前，发向一个
候选地址。