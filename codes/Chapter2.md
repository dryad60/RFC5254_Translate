# 2. ICE总览
------
在一个典型的**ICE**环境下，我们有两个端点需求通讯。它们可以通过一些信令协议（例如SIP), 交换SDP消息应答来实现间接的通讯。注意，**ICE**并不是为了
实现SIP的NAT穿越, 这应该被其他机制完成。首先，**ICE**并不关心端点的网络拓扑，它们可能位于或不位于NAT, 或者在多重NAT拓扑中。**ICE**会让通讯端点
发现有关自己所处网络拓扑的尽可能多的信息，以找到一个或多个可以通讯的网络路径。

![Figure1](https://github.com/dryad60/RFC5254_Translate/blob/master/images/Figure1.png?raw=true) ***图1***  

图一展示了一种典型的**ICE**拓扑。两个通信端点命名为:L 和 R。L和R都位于NAT中，它们并不清楚这件事，而且NAT的类型和属性也是未知的。
LR能够通过请求/应答这种形式交换SDP消息来创建一个多媒体会话。这一般需要依赖一个SIP服务器。在这些之外，ICE协议一般会使用STUN或TURN服务器。
每个端点可以使用自己的STUN或TURN服务器，或者使用同一个。  
ICE的基本理念是:  
每个端点具有各种的`候选通讯地址`(支持某个通讯协议的一对IP地址和端口，一般使用UDP),可以尝试用来跟其他端点通讯。  
候选通讯地址包括:  
+ 本地网络地址
+ NAT转换地址(STUN Server反射地址)
+ TURN分配的中转地址  
理论上，L的任一候选地址都可以尝试与R的任一候选地址尝试通讯。实际上，某些组合肯定是不行的。例如L/R都在NAT之后时，他们的本地网络地址是肯定无法
直接通讯的。ICE的目的，就是在有序而规则的步骤下，寻找那些地址组合可以用来进行通讯。


### 2.1 收集候选地址  
  
一个端点需要找出它的所有候选地址以尝试ICE。一个候选地址是指一个工作于某个协议下(这里专指UDP)的IP地址加端口组合。本文档定义了3类候选地址，一些是从
物理或者逻辑网络接口获取的地址，一些是通过STUN和TURN服务发现的地址。那么，从本地网络接口上就可以获取到一个可用的候选地址，这个地址称为:"HOST候选"。
HOST候选可以从本地有线连接或WIFI连接上获得，也可以是VPN，MIP等其他网络接口。  

如果一个端点是多重地址的，那么它应该从每一个本地IP地址上取得一个候选地址。根据目标通讯端点的所处网络，这个端点可以通过其中1个或多个地址连接到对方。例如一个端点有
一个工作在私有网络上的地址I1和一个工作在公网网络上的地址I2，那么另外一个也处于此私有网络上的端点可以通过I1通讯，处于公网上端点则通过I2通讯。因此请求端点应该包含
它所有的候选地址，而不是去估计哪个候选地址才是有效的。  
接下来，端点应该通过STUN或TURN协议去获取其他的候选地址。这些地址来自于：NAT公网转换地址(服务反向候选)和TURN服务器地址(中继候选地址)。当部署了TRUN服务器时，这些
地址都可以通过TURN服务器获取。如果只部署了STUN服务器，那么只能获取到服务反向候选地址。这些候选和HOST候选的关系，显示在图2中。图2中，两种候选地址都由TRUN服务器来获取。
X:x 表示 IP地址X和UDP端口x。  

![Figure2](https://github.com/dryad60/RFC5254_Translate/blob/master/images/Figure2.png?raw=true) ***图2***  

当端点以"X:x"的IP和端口向TURN发送地址分配请求时，NAT会创建一个绑定"X1:x1",用来对应服务反向地址到本地候选地址X:x.本地从X:x发出去的数据包会被NAT转换为X1:x1。而从
服务器到达NAT的目标为X1:x1的包则又会被转换为X:x.这样的对应关系中的HOST候选被称为"The BASE"。当端点和TURN服务器之间存在多重NAT时，NAT转换和绑定会发生在每一个NAT，但是基本只有
最外层的NAT的服务反向候选地址可以被发现。如果端点和TURN之间没有NAT，那么可以发现BASE HOST候选和服务反向候选是一样的，这样服务反向候选可以被排除。  
当地址分配请求到达TURN服务器后，服务器会为请求在自己的地址Y上分配一个端口y, 然后生成应答包，通知端点。应答包中也会携带端点的服务反向地址X1:x1,以让端点获取自己的服务
反向地址。TURN服务器在L/R的通讯间充当中继角色。当R要向L发送数据时，它发送数据到TURN的Y:y, TURN把数据导向X1:x1, 这样再通过NAT转换把数据发往X:x, 也就是L。  
当部署了STUN服务器时,端点发送STUN绑定请求到服务器。STUN服务器会通知端点它的服务反向候选地址X1:x1, 做法就是复制请求的源地址到应答包中。


### 2.2 连接性检查

当端点L收集到它所有的候选地址后，把它们按优先级从高到低排列，通过信令通道发送给端点R。候选地址作为SDP属性携带在SDP请求中。当R收到了这个请求后，也同样是收集自己的候选地址
并排序后发送给L。这样，最终两个端点LR都获取到自己和对方的排序过的候选地址列表。它们把候选地址配对，组成候选地址对。然后进行检查，哪些候选地址对可以进行连接。这种检查
是通过STUN请求/响应来完成。
连接性检查规则如下：
1. 按一定优先级排列候选地址
2. 按顺序发送配对检查
3. 从对应端点接受响应
由于通讯双方都需要进行连接检查，所以这种检查是“4次握手”。
需要注意，STUN请求/响应和多媒体数据（RTCP和RTP)会使用相同的IP地址和端口。因此，通信端点应该对通讯包按内容进行解复用，而不是通过端口来区分。幸运的是，这实际并不困难。

由于STUN绑定请求可以用来做连接检查，因此STUN绑定响应会包含端点的已被翻译的公网NAT传输地址。如果这个传输地址和先前端点收集到的候选地址都不相同，则以此会生成一个新的
候选地址 "对等反射地址"，这个候选也会用来做连接性检查。

作为一种优化，当端点R收到L的连接检查消息时，会立即在相同的候选地址配对上发起连接检查。这样可以加速找到可以使用的候选地址对，这被称为“触发式检查”。

在握手完成之后，L/R可以找到一个双向的点对点通讯通道。

### 2.3 候选地址排序

因为连接性检查算法是作用在所有的候选地址对上，为了产生更快的结果，候选地址应该进行排序。排序后的结果称为“检查列表”。排序算法描述在4.1.2节中，遵循两个主要原则：

1：每个端点给自己的候选地址一个数字优先级，并把这个信息发送给对端；
2：本地和对端的优先级会结合在一起，这样两端就有同样的优先顺序的候选地址对。

第二条对处于NAT之后的端点尤为重要。通常NAT不允许一个主机的消息通过，除非NAT之后的主机已经给这个主机发过消息了。因此，ICE检查只会在NAT双方的主机都发送过CHECK
消息后才会成功穿越NAT而成功。

端点会通过依次对检查列表里的优先级排列的候选地址对发送一个STUN请求来进行连接检查。这被成为“普通检查”。

优先级算法包括同类型的候选地址具有同样的优先级以及更直接的路由（更少的中继和更少的NAT）优先于那些更间接的路由。在这样指引规则下，各个端点有一定的自由和判断来
微调它们自己的算法。

### 2.4 冻结的候选地址

前面的章节描述的是那些在只需要建立一个组件（就是一个通讯链路或地址）进行多媒体通讯的端点间如何工作。但是一些端点可能需要建立连接在多个组件上（例如RTP和RTCP）。

这些多个组件间的网络模型是十分类似的(特别是RTP和RTCP都是在同样的网路地址上进行消息收发)。因此经常可以利用一个多媒体组件来选取最好的候选地址来
应用到其他组件上。这被成为“冻结候选地址”。

每个候选地址都有一个属性：基础设定（FOUNDATION）。两个候选地址如果是相似的 -- 具有同样的类型，从同一个主机地址分配，同样协议的STUN服务器，则
认为她们具有相同的基础设定。否则，则基础设定不相同。一个候选地址对也有基础设定，就是对里的两个候选地址的基础设定的合并。开始时，只检查地址对里
具有不同基础设定的地址对，其余的地址对处于冻结状态。当一个地址对的连接性检查成功后，其余的地址对中具有相同的基础设定的那些就可以解冻。这样可以
提高检查的成功率，避免去尝试那些可能无法连接但看起来有效的地址对。

这里描述的“冻结”算法看起来是一个独立进制，但实际上是ICE和ICE优先级算法中一个非常有效的部分，它可以保证正确的候选地址被解冻和进行正确次序的连接检查。

### 2.5 连接检查安全性

ICE是用来确定在两个端点间通过什么地址来收发媒体数据，所以保证整个过程不被破坏与劫持以让数据发送到错误的地址就非常重要。每个STUN连接检查会通过在信号通道里
交换一个KEY来计算Message Authentication Code(消息加密码)进行安全保护。MAC提供数据完整校验和原始加密，防止伪造或篡改连接检查消息。更特别的，如果一个
使用ICE的SIP对话发起者复制生成了多个调用以对应多个接受者的话，ICE交换交换将会在每个接收者链路独立发生。这种情况下，信号通道里的Key交换作用于每一个接收者
的单独的ICE通道。

### 2.5 ICE的结束















