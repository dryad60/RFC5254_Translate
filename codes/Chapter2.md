# 2. ICE总览
------
在一个典型的**ICE**环境下，我们有两个端点需求通讯。它们可以通过一些信令协议（例如SIP), 交换SDP消息应答来实现间接的通讯。注意，**ICE**并不是为了
实现SIP的NAT穿越, 这应该被其他机制完成。首先，**ICE**并不关心端点的网络拓扑，它们可能位于或不位于NAT, 或者在多重NAT拓扑中。**ICE**会让通讯端点
发现有关自己所处网络拓扑的尽可能多的信息，以找到一个或多个可以通讯的网络路径。

![Figure1](https://github.com/dryad60/RFC5254_Translate/blob/master/images/Figure1.png?raw=true) ***图1***  

图一展示了一种典型的**ICE**拓扑。两个通信端点命名为:L 和 R。L和R都位于NAT中，它们并不清楚这件事，而且NAT的类型和属性也是未知的。
LR能够通过请求/应答这种形式交换SDP消息来创建一个多媒体会话。这一般需要依赖一个SIP服务器。在这些之外，ICE协议一般会使用STUN或TURN服务器。
每个端点可以使用自己的STUN或TURN服务器，或者使用同一个。  
ICE的基本理念是:  
每个端点具有各种的`候选通讯地址`(支持某个通讯协议的一对IP地址和端口，一般使用UDP),可以尝试用来跟其他端点通讯。  
候选通讯地址包括:  
+ 本地网络地址
+ NAT转换地址(STUN Server反射地址)
+ TURN分配的中转地址  
理论上，L的任一候选地址都可以尝试与R的任一候选地址尝试通讯。实际上，某些组合肯定是不行的。例如L/R都在NAT之后时，他们的本地网络地址是肯定无法
直接通讯的。ICE的目的，就是在有序而规则的步骤下，寻找那些地址组合可以用来进行通讯。


### 2.1 收集候选地址  
  
一个端点需要找出它的所有候选地址以尝试ICE。一个候选地址是指一个工作于某个协议下(这里专指UDP)的IP地址加端口组合。本文档定义了3类候选地址，一些是从
物理或者逻辑网络接口获取的地址，一些是通过STUN和TURN服务发现的地址。那么，从本地网络接口上就可以获取到一个可用的候选地址，这个地址称为:"HOST候选"。
HOST候选可以从本地有线连接或WIFI连接上获得，也可以是VPN，MIP等其他网络接口。  

如果一个端点是多重地址的，那么它应该从每一个本地IP地址上取得一个候选地址。根据目标通讯端点的所处网络，这个端点可以通过其中1个或多个地址连接到对方。例如一个端点有
一个工作在私有网络上的地址I1和一个工作在公网网络上的地址I2，那么另外一个也处于此私有网络上的端点可以通过I1通讯，处于公网上端点则通过I2通讯。因此请求端点应该包含
它所有的候选地址，而不是去估计哪个候选地址才是有效的。  
接下来，端点应该通过STUN或TURN协议去获取其他的候选地址。这些地址来自于：NAT公网转换地址(服务反向候选)和TURN服务器地址(中继候选地址)。当部署了TRUN服务器时，这些
地址都可以通过TURN服务器获取。如果只部署了STUN服务器，那么只能获取到服务反向候选地址。这些候选和HOST候选的关系，显示在图2中。图2中，两种候选地址都由TRUN服务器来获取。
X:x 表示 IP地址X和UDP端口x。  

![Figure2](https://github.com/dryad60/RFC5254_Translate/blob/master/images/Figure2.png?raw=true) ***图2***  

当端点以"X:x"的IP和端口向TURN发送地址分配请求时，NAT会创建一个绑定"X1:x1",用来对应服务反向地址到本地候选地址X:x.本地从X:x发出去的数据包会被NAT转换为X1:x1。而从
服务器到达NAT的目标为X1:x1的包则又会被转换为X:x.这样的对应关系中的HOST候选被称为"The BASE"。当端点和TURN服务器之间存在多重NAT时，NAT转换和绑定会发生在每一个NAT，但是基本只有
最外层的NAT的服务反向候选地址可以被发现。如果端点和TURN之间没有NAT，那么可以发现BASE HOST候选和服务反向候选是一样的，这样服务反向候选可以被排除。  
当地址分配请求到达TURN服务器后，服务器会为请求在自己的地址Y上分配一个端口y, 然后生成应答包，通知端点。应答包中也会携带端点的服务反向地址X1:x1,以让端点获取自己的服务
反向地址。TURN服务器在L/R的通讯间充当中继角色。当R要向L发送数据时，它发送数据到TURN的Y:y, TURN把数据导向X1:x1, 这样再通过NAT转换把数据发往X:x, 也就是L。  
当部署了STUN服务器时,端点发送STUN绑定请求到服务器。STUN服务器会通知端点它的服务反向候选地址X1:x1, 做法就是复制请求的源地址到应答包中。











