# 7 执行连接检查
------
本章描述连接检查是如何执行的。所有的ICE实现要求遵循 RFC5389, 而不支持旧的RFC3489.因此，完全实现下会生成检查(作为STUN客户端)和接受检查(作为STUN服务器),
而简化实现只会接收检查消息(作为STUN服务器)。

# 7.1 STUN客户端流程
本节描述在完全实现下，端点如何发送一个连接检查，无论是一般检查或是触发检查。

# 7.1.1 为中继候选创建许可
如果一个连接检查是使用中继候选的本地地址发送，那端点需要首先生成一个许可。也有可能在之前端点已经向TURN服务器请求生成了一个许可-中继本地候选发往远程候选。
按照RFC5766来生成这个许可，许可依赖远程候选的IP地址。建议端点应该推迟创建TURN通道直到ICE完成，这时创建许可一般由“创建许可”请求来完成。一旦创建后，端点
需要保持这个许可直到ICE结束。

# 7.1.2 发送请求
检查是通过发送一个绑定请求从本地候选到远程候选。RFC5389描述了请求是如何构建生成的。连接检查需要初始化STUN短期凭据机制。连接检查不用向后兼容RFC3489。
而指纹机制必须在连接检查中使用。
ICE通过定义了很多新的属性来扩展STUN服务，包括优先级(PRIORITY)，使用的候选(USE-CANDIDATE)，ICE控制(ICE-CONTROLLING)和ICE被控制(ICE-CONTROLLED)。
这些属性的格式和使用方法在小节19.1中。这些STUN扩展只在ICE连接检查时被使用。

# 7.1.2.1 优先级与使用的候选
端点在它的绑定请求中，必须包含优先级属性。这个属性值必须等于根据小节4.1.2小节的算法计算出的结果，对于对端反射候选，这个值应该是在连接检查过程中获取的一个结果值
(获取方法参照小节7.1.3.2.1)。这个优先级的值是独立于本地候选的优先级计算的，除非类型偏好设置为了对端反射候选。

控制端点还可能绑定请求中包含USE-CANDIDATE属性。被控制端点没有这个属性。这个属性表示控制端点期望结束该组件的连接检查，打算使用这个候选对的检查结果。小节8.1.1
提供了这个属性的使用指引。

# 7.1.2.2 控制与被控制
端点在作为控制端点时，必须包含ICE-CONTROLLING属性，而作为被控制端点，则需要ICE-CONTROLLED属性。这两个属性的值必须是tie-breaker(5.2小节)。这些属性
在19.1中有完全的定义说明。

# 7.1.2.3 生成凭据
用绑定请求做连接检查时，必须启用STUN短期凭据机制。凭据的用户名是由对端的用户名片段和本端点的用户名片段拼接生成，拼接符一个‘:'。密码等于对端提供的密码。比如，L是请求
端点，R是回应端点。L的候选包含了一个用户名片段LFRAG和密码LPASS。R则使用用户名片段RFRAG和密码RPASS。那么从L到R的连接检查就会使用用户名 RFRAG:LFRAG和密码RPASS。
而反向的从R到L的连接检查则会使用 LFRAG:RFRAG 和密码 LPASS。响应消息依照请求使用同样的用户名和密码（注意响应消息里没有USERNAME属性)。

# 7.1.2.4 区分服务处理
如果端点使用了区分服务标记(Diffserv Codepoint markings,FRC2475)，在它的消息包里，那么它需要在连接检查里也应用同样的标记。


# 7.1.3 处理响应
当收到一个绑定请求时，关系着把绑定请求中的事务ID(RFC5389),绑定到绑定请求发送的那个候选。本章节描述了绑定请求的后续操作。

# 7.1.3.1 失败的情况
如果STUN事务返回了一个487(`角色冲突`)错误响应，端点应该检查绑定请求是否包含了ICE-CONTROLLED或ICE-CONTROLLING。端点必须切换到请求中角色属性对应的角色，
如果还没有的话。一旦切换完成，端点必须把产生487错误这个候选对插入到触发检查队列中。该候选对的状态设置为Waiting。当触发检查发送时，请求中就会携带ICE-CONTROLLED
或ICE-CONTROLLING以表现它的新角色。要注意，tie-breaker值必须不变，不能重新设置。

端点的角色改变会导致重新计算候选对优先级(5.7.2小节), 因为优先级是和控制/被控制角色关联的。角色的改变也影响端点在结束ICE流程时对决定最终候选对和
生成更新请求的处理。

端点可能在连接检查时支持接收ICMP错误。如果STUN事务生成了ICMP错误，端点应该设置候选对状态为Failed。如果STUN事务收到了STUN错误不可恢复(RFC5389)或超时，
端点也会设置候选对为Failed。

端点必须检查响应的源IP地址和端口等于绑定请求发送的目的IP地址和端口，而响应的目地IP地址和端口也等于绑定请求发送的源地址和端口。即请求和响应中的地址和端口是
对称的。如果不是这样，则设置候选对为Failed状态。

# 7.1.3.2 成功的情况
一个检查在以下条件都满足时认为是成功的：
+ STUN事务响应成功
+ 响应的源地址和端口等于绑定请求发送的目标地址和端口
+ 响应的目标地址和端口和绑定请求发送的源地址和端口匹配

# 7.1.3.2.1 对端反射候选的发现
端点检查STUN响应中的匹配地址。如果该通讯地址不匹配任何已经发现的本地候选，则该通讯地址就是一个新的候选-对端反射候选。跟其他候选一样，这个候选也有本地地址，
优先级和基础设定。他们的计算方法如下：
+ 类型为对端反射候选
+ 本地地址为发送STUN检查的候选对中的本地候选
+ 优先级和STUN绑定请求中的优先级属性值相同
+ 基础设定的选择如小节4.1.1.3

然后这个候选就加入了该媒体流的本地候选列表中。它的用户名片段和密码和媒体流下其他的本地候选一样。不过，对端反射地址还没有和任何远程候选配对。这不是必要的，
因为这个候选会在 7.1.3.2.2小节描述的处理流程中立即产生候选对。如果端点还想把这个候选产生其他的可能的候选对，应该发送一个包含该对端反射候选的更新请求。
这样会导致这个候选会和所有的远程候选配对。

# 7.1.3.2.2 生成一个有效对




