# 7 执行连接检查
------
本章描述连接检查是如何执行的。所有的ICE实现要求遵循 RFC5389, 而不支持旧的RFC3489.因此，完全实现下会生成检查(作为STUN客户端)和接受检查(作为STUN服务器),
而简化实现只会接收检查消息(作为STUN服务器)。

# 7.1 STUN客户端流程
本节描述在完全实现下，端点如何发送一个连接检查，无论是一般检查或是触发检查。

# 7.1.1 为中继候选创建许可
如果一个连接检查是使用中继候选的本地地址发送，那端点需要首先生成一个许可。也有可能在之前端点已经向TURN服务器请求生成了一个许可-中继本地候选发往远程候选。
按照RFC5766来生成这个许可，许可依赖远程候选的IP地址。建议端点应该推迟创建TURN通道直到ICE完成，这时创建许可一般由“创建许可”请求来完成。一旦创建后，端点
需要保持这个许可直到ICE结束。

# 7.1.2 发送请求
检查是通过发送一个绑定请求从本地候选到远程候选。RFC5389描述了请求是如何构建生成的。连接检查需要初始化STUN短期凭据机制。连接检查不用向后兼容RFC3489。
而指纹机制必须在连接检查中使用。
ICE通过定义了很多新的属性来扩展STUN服务，包括优先级(PRIORITY)，使用的候选(USE-CANDIDATE)，ICE控制(ICE-CONTROLLING)和ICE被控制(ICE-CONTROLLED)。
这些属性的格式和使用方法在小节19.1中。这些STUN扩展只在ICE连接检查时被使用。

# 7.1.2.1 优先级与使用的候选
端点在它的绑定请求中，必须包含优先级属性。这个属性值必须等于根据小节4.1.2小节的算法计算出的结果，对于对端反射候选，这个值应该是在连接检查过程中获取的一个结果值
(获取方法参照小节7.1.3.2.1)。这个优先级的值是独立于本地候选的优先级计算的，除非类型偏好设置为了对端反射候选。

控制端点还可能绑定请求中包含USE-CANDIDATE属性。被控制端点没有这个属性。这个属性表示控制端点期望结束该组件的连接检查，打算使用这个候选对的检查结果。小节8.1.1
提供了这个属性的使用指引。

# 7.1.2.2 控制与被控制
端点在作为控制端点时，必须包含ICE-CONTROLLING属性，而作为被控制端点，则需要ICE-CONTROLLED属性。这两个属性的值必须是tie-breaker(5.2小节)。这些属性
在19.1中有完全的定义说明。

# 7.1.2.3 生成凭据
用绑定请求做连接检查时，必须启用STUN短期凭据机制。凭据的用户名是由对端的用户名片段和本端点的用户名片段拼接生成，拼接符一个‘:'。密码等于对端提供的密码。比如，L是请求
端点，R是回应端点。L的候选包含了一个用户名片段LFRAG和密码LPASS。R则使用用户名片段RFRAG和密码RPASS。那么从L到R的连接检查就会使用用户名 RFRAG:LFRAG和密码RPASS。
而反向的从R到L的连接检查则会使用 LFRAG:RFRAG 和密码 LPASS。响应消息依照请求使用同样的用户名和密码（注意响应消息里没有USERNAME属性)。

# 7.1.2.4 区分服务处理
如果端点使用了区分服务标记(Diffserv Codepoint markings,FRC2475)，在它的消息包里，那么它需要在连接检查里也应用同样的标记。


# 7.1.3 处理响应
当收到一个绑定请求时，关系着把绑定请求中的事务ID(RFC5389),绑定到绑定请求发送的那个候选。本章节描述了绑定请求的后续操作。

# 7.1.3.1 失败的情况
如果STUN事务返回了一个487(`角色冲突`)错误响应，端点应该检查绑定请求是否包含了ICE-CONTROLLED或ICE-CONTROLLING。端点必须切换到请求中角色属性对应的角色，
如果还没有的话。一旦切换完成，端点必须把产生487错误这个候选对插入到触发检查队列中。该候选对的状态设置为Waiting。当触发检查发送时，请求中就会携带ICE-CONTROLLED
或ICE-CONTROLLING以表现它的新角色。要注意，tie-breaker值必须不变，不能重新设置。

端点的角色改变会导致重新计算候选对优先级(5.7.2小节), 因为优先级是和控制/被控制角色关联的。角色的改变也影响端点在结束ICE流程时对决定最终候选对和
生成更新请求的处理。

端点可能在连接检查时支持接收ICMP错误。如果STUN事务生成了ICMP错误，端点应该设置候选对状态为Failed。如果STUN事务收到了STUN错误不可恢复(RFC5389)或超时，
端点也会设置候选对为Failed。

端点必须检查响应的源IP地址和端口等于绑定请求发送的目的IP地址和端口，而响应的目地IP地址和端口也等于绑定请求发送的源地址和端口。即请求和响应中的地址和端口是
对称的。如果不是这样，则设置候选对为Failed状态。

# 7.1.3.2 成功的情况
一个检查在以下条件都满足时认为是成功的：
+ STUN事务响应成功
+ 响应的源地址和端口等于绑定请求发送的目标地址和端口
+ 响应的目标地址和端口和绑定请求发送的源地址和端口匹配

# 7.1.3.2.1 对端反射候选的发现
端点检查STUN响应中的匹配地址。如果该通讯地址不匹配任何已经发现的本地候选，则该通讯地址就是一个新的候选-对端反射候选。跟其他候选一样，这个候选也有本地地址，
优先级和基础设定。他们的计算方法如下：
+ 类型为对端反射候选
+ 本地地址为发送STUN检查的候选对中的本地候选
+ 优先级和STUN绑定请求中的优先级属性值相同
+ 基础设定的选择如小节4.1.1.3

然后这个候选就加入了该媒体流的本地候选列表中。它的用户名片段和密码和媒体流下其他的本地候选一样。不过，对端反射地址还没有和任何远程候选配对。这不是必要的，
因为这个候选会在 7.1.3.2.2小节描述的处理流程中立即产生候选对。如果端点还想把这个候选产生其他的可能的候选对，应该发送一个包含该对端反射候选的更新请求。
这样会导致这个候选会和所有的远程候选配对。

# 7.1.3.2.2 生成一个有效对
端点会生成一个候选对，本地候选为响应的映射地址而远程候选为请求发送的目的地址。这成为一个有效对，因为这个对已经通过STUN连接检查完成了连接校验。这个有效对
可能与生成它的候选对一样，或是和检查列表里的一个对一样，或是没有出现在检查列表里。如果该候选对等于检查列表里某个候选对或是等于生成它的那个候选对，则把这个
候选对加入到端点给每个媒体流维护的有效候选对列表里。这个列表在ICE处理开始时为空，后续会被连接检查有效的候选对填充。
非常普遍的是该候选对没有出现在检查列表里。重新说明一遍，候选列表里的候选对的本地候选不会是服务反射地址，这些对的本地候选会被转换为服务反射候选的基础本地地址，然后
修剪如果有重复。当STUN检查的响应到达时，会获得一个反射映射地址，如果两个端点在NAT之间。在这种情况下，这个有效候选对就会有一个本地候选不会在和检查列表里的任何
地址所匹配。
如果有效对没有在检查列表里，端点需要给他计算优先级，基于它的每个候选地址的优先级，参照小节5.7的算法。本地候选的优先级基于它的类型。如果它不是对端反射，它的优先级
就等于SDP中给候选分配的优先级。如果是对端反射类型，优先级就等于端点给绑定请求生成的优先级。而远程候选的优先级就是对端SDP的优先级。如果候选没有在SDP中出现，则这
个检查一定是对一个新的远程候选的触发检查。这种情况下，优先级等于绑定请求中计算出的优先级值。然后，这个对就加入到了优先列表中。

# 7.1.3.2.3 更新候选对状态
端点设置生成了检查的候选对状态为成功。要注意，已生辰关键差点候选对和小节7.1.3.2.2处理结果的有效候选对是不用的。检查的成功也会导致其他检查的状态变化。
过程如一下两步:
1. 端点把同一媒体流下的相同基础设定的所有Frozon候选对设置为Waiting。典型的，但不是一定的，这些候选对可能有不同的组件ID。
2. 如果这个媒体流下的所有组件的有效列表里都有一个候选对(实际正被使用的组件，可能SDP中请求者和响应着的组件数量不同)，这个检查的成功会解冻其他媒体流的检查。
注意这只发生第一次一个有效候选对加入到有效列表，不包括后续的加入。端点会依次检查其他的媒体流:
    + 如果检查列表是活动的，端点会把所有具有有效候选对相同基础设定的Fronzen候选对设置为Waiting。
    + 如果检查列表是Fronzen，并且表里至少有一个候选对的基础设定和有效候选对的设定相同，端点把检查列表所有基础设定匹配的候选对设置为Waiting。
    这会把检查列表变为活动状态，并且一般检查会开始，如小节5.8
    + 如果列表是Frozen，并且没有找到候选对的基础设定与有效的匹配，那接下来：
        + 把列表中的候选对按基础设定分组
        + 每个组中，把组件ID最小的候选对设置为Waiting。如果这样的候选对有多个，使用最高优先级的那一个
        
# 7.1.3.2.4 更新提名标记
如果端点是控制端点，在它的绑定请求中有USE-CANDIDATE属性，则这个检查生成的有效对会把提名标记设置为真。这个标记表示这个有效对会用来做数据传输，如果它是所有
带有提名标记的候选对中优先级最高的那个。这有可能终止本媒体流或所有媒体流的ICE处理，如章节8.

如果端点是被控制端点，则响应可能是对一个触发检查的响应，响应中会带有USE-CANDIDATE属性。这种情形描述在小节7.2.15中，可能会给从初始请求中获取这个候选对设置决定
标记。

# 7.1.3.3 检查列表和定时状态更新
不管检查的结果是成功或失败，检查事务的完成都要求更新检查列表和定时器的状态。如果所有的检查列表候选对现在都处于成功或失败的状态，
+ 如果媒体流的所有组件下的有效列表中都没有候选对，则列表的状态设置为失败。
+ 对于每个冻结的检查列表，端点应该
    + 把候选对按基础设定进行分组
    + 把每个组中最小组件ID（多个则去优先级最高那个）的候选对设置为Waiting。
如果列表中没有候选对在Waiting或是Fronzen状态, 则认为列表不再活动，也不再使用5.8小节的一般检查的定时器。


# 7.2 STUN服务器处理
端点需要准备好在它最近使用的每个请求或响应的候选对的基础地址上接受绑定请求。这个要求在简化实现也是需要完成的。
端点必须使用一个短期凭据认证请求和验证消息完成性。端点必须保证用户名有效如果是通过冒号分割两个值，第一个值要等于正在处理的会话的请求或响应中的用户名片段。
非常可能的是请求者可能先收到一个绑定请求从它的对端而不是收到响应。这时，端点必须立即完成一个响应(包含了计算映射地址,小节7.2.1.2)。对端的密码不是必须的，
所以此时端点有足够的信息来生成这个响应。当收到响应时，端点必须完成剩下的完全实现步骤, 小节7.2.1.3/7.2.1.4/7.2.1.5。如果在收到对端响应前收到了多个STUN
请求，这可能导致多个候选对在触发队列中排队。

端点不能使用ALTERNATE-SERVER机制, 不能支持向RFC 3489的向后兼容。它必须使用 FINGERPRINT 机制。

如果端点在媒体数据包中使用了Diffserv Codepoint Marking, 它应该把这个属性也添加到绑定请求的响应中。同理对任意的 2层marking.

# 7.2.1 完全实现的附加处理
本章节展示了对于完全实现的附件服务器处理流程。

# 7.2.1.1 检查和纠正角色冲突
一般来说，按照小节5.2每个端点会选择不同的角色-控制端点和被控制端点。但是，在某些不常见的流程下，特别是第三方调用控制，使得有可能两个端点都选择了同一个角色。
本节描述了如何检查和修正这个错误。
端点必须检查绑定请求中的ICE-CONTROLLING或ICE-CONTROLLED属性，步骤：
+ 如果请求中ICE-CONTROLLED和ICE-CONTROLLING都没有，那么对端可能运行的是一个低版本的ICE。这里会用冲突错误发生，但是就无法检查到了。
+ 如果本端点在控制端点角色，而请求中表明也是控制端点：
    + 如果本端点的tie=breaker大于或等于请求中的ICE-CONTROLLING属性，则生成一个绑定错误响应，携带487(ROLE Conflict)错误给对方，并保持自己的角色。
    + 如果本端点的tie-breaker小于对方ICE-CONTROLLING属性，则切换为被控制端点。
+ 如果端点工作在被控制端点角色，而对方请求也是被控制端点：
    + 如果本端点的tie-breaker大于等于对端ICE-CONTROLLED属性，则本端点切换为控制端点。
    + 如果tie-breaker小于对端的ICE-CONTROLLED属性, 则生成487错误(Role Conflict)的绑定错误响应返回对方，自己保持角色。
其他正常情况下则没有角色冲突。
角色的变化则要求端点重新计算候选对优先级(5.7.2小节), 因为优先级是和角色有关的。角色的改变也会影响端点是否响应候选对的选择决定和是否生成更新请求以结束ICE。

7.2.1小节的接下来的内容是服务器给绑定请求生成了成功的响应，但是端点的角色发生了变化。

# 7.2.1.2 计算映射地址
对于在中继候选上收到的请求，用来STUN处理的源传输地址(就是XOR-MAPPED-ADDRESS属性)就是TURN服务器看到的传输地址。源传输地址会以数据指示消息的XOR-PEER-ADDRESS
属性出现，如果绑定请求是通过数据指示来发送。如果绑定消息是通过通道数据消息来发送，则源传输地址就是通道的传输地址。

# 7.2.1.3 获取对端反射候选
如果请求的源传输地址不和任意存在的远程候选所匹配，则它是一个新的对端反射候选。该候选如下构造：
+ 优先级等于请求的优先级属性
+ 类型为对端反射候选。
+ 基础设定为设置一个特有值，和其他所有远程候选区分开。接下来后续的请求/响应消息如果包含了这个候选在SDP中，则会后续通知它的真正的基础设定。
+ 组件ID设置为接收到该请求的本地候选的组件ID。
这个候选添加到远程候选列表中。该候选还没有和任何本地候选配对。

# 7.2.1.4 触发的检查
接下来，端点会创建一个候选对，本地候选为STUN请求接收到的本地传输地址，远程候选则是传输地址是请求来源地址的(这个地址可能是刚刚获取到对端反射候选)。本地候选可能
是一个主机候选(如果不是从中继收到请求)或中继候选（请求是从中继获取到），但是不会是一个服务反射地址候选。当两个候选都知道后，就可以计算候选的优先级和候选对的
优先级。然后会在检查列表中搜索这个候选对，结果可能有几种：
+ 如果这个候选对已经在检查列表中:
    + 如果候选对状态是Waiting或Frozen, 则该对的连接检查会被插入到触发检查队列中（如果触发队列中没有)
    + 如果状态是In-Progress, 则取消这个In-Progress事务。取消是指端点不会再重发请求，不会认为没收到响应是一个失败，而是会等待事务的超时时间来获取一个响应。
    因此的，端点必须通过把这个对放到触发检查队列中,为这个候选对创建一个新的连接检查(开始一个新的STUN绑定请求事务)。这个对的状态变为Waiting。
    + 如果状态是Failed, 则改变状态为Waiting并且端点把这个候选对放到触发检查队列中,为这个候选对创建一个新的连接检查(开始一个新的STUN绑定请求事务)。
    + 如果状态是Succeeded, 则不用做什么处理了。
这些步骤可以促进两个位于NAT之后的端点快速的完成ICE处理。

+ 如果这个候选对没有在检查列表中:
    + 把它按照优先级插入到检查列表中
    + 状态设置为Waiting
    + 同时插入到触发检查队列中。
当触发检查发出时，按照小节7.1.2构造和处理。这个过程要求端点知晓对端的通讯地址，用户名片段和密码。对端用户名片段是接收到的绑定请求中的USERNAME中的冒号后面的部分。
通过对对端SDP消息的处理，就可以找到要使用的用户名片段，同时对应的密码也可以被找到。

# 7.2.1.5 更新提名标记
当收到的绑定请求带有USE-CANDIDATE属性标记，并且端点是在被控制角色下，端点会查看候选对如小节7.2.1.4计算出的状态：
+ 如果候选对状态是Succeeded，表示这个对上的检查得到了一个成功的响应。这会触发端点创建一个有效的候选对（小节7.1.3.2.2）。端点把有效对的提名标记设置为真。
  这可能会结束掉ICE处理过程，小节8.
+ 如果候选对状态是In-Progress, 而检查响应是一个成功的结果，则结果有效候选对会带有提名标记。这可能会结束ICE处理，小节8。

# 7.2.2 简化实现的附加处理
当收到的检查包含了USE-CANDIDATE属性时，端点就生成一个候选对，本地候选等于请求接收的通讯地址，远程候选等于请求的源通讯地址。这个候选对会分配一个特定的优先级，
然后帮到一个有效候选列表里。端点会把这个候选对的提名标记设置为true。ICE处理会在所有的媒体流的有效候选列表都有候选时认为ICE已完成。










