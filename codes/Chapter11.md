# 11 媒体数据处理
------
# 11.1 发送媒体数据
发送媒体数据在完全实现和简化实现下是不同的。

# 11.1.1 完全实现流程
端点一般使用一个候选对进行数据发送，即被选中候选对。端点会把数据发往候选对的远程候选（把数据包的目的地址和端口设置为远程候选的）, 会在本地候选上进行发送。
如果本地候选是服务反射或对端反射地址，数据在组织在反射地址的基础地址上。发往中继候选的媒体数据是从TURN服务器的基础地址，流程RFC5766.

如果本地候选是中继候选，建议端点应该在TURN服务器上建立一个指向远程候选的通道。这个建立通道的流程参照 RFC5766的小节11。

媒体流的组件的选中候选对是：
+ 为空，当媒体流的检查列表状态是Running并且组件没有以前选中的候选对，在ICE重启时
+ 等于以前组件选中的候选对，当媒体流的检查列表状态是Running而组件有一个以前选中的候选对，在ICE重启时
+ 等于组件有效列表中最高优先级的提名候选对，当检查列表的状态是Completed
如果媒体流中有一个组件的选中候选对为空，端点就不能在媒体流的任何组件上发送数据。只有所有的组件的选中候选对有一个值时，才可以进行发送。注意组件的被选中对可能不等于
该组件最近的响应/请求交换的默认对。这种情况下，选中候选对会用来媒体通讯，而不是默认对。当ICE第一次完成时，如果选中对不等于默认候选对，控制端点会发送一个更新消息
来请求/响应以解决这个不一致。因此在收到更新请求之前，这里可能都不会匹配上。更加有可能的，在一些不常见的情况下，默认候选在更新请求/响应中都没有匹配上。

# 11.1.2 简化实现流程
简化实现时端点会知道每个组件的有效列表中都包含一个有效候选对后才会发送媒体数据。端点会把数据发往候选对的远程候选（把数据包的目的地址和端口设置为远程候选的）, 
会在本地候选上进行发送。

# 11.1.3 所有实现的流程
ICE具有抖动缓冲适应的交互机制。一个RTP流可以开始时使用一个候选，然后随后切换到另外一个候选，虽然这在ICE里很不常见。这个新的候选可能导致RTP包通过网络的一个
不同的路径进行传输，而这个路径有不同的网络延迟特征。如下讨论，端点鼓励机型抖动缓冲的重新判断，在媒体数据的源或目标地址发生改变时。而且，很多音频编码器使用标志位
来表示语音段的开始，就是为了抖动缓冲适应。对于这样的编码器，建议发送者在通讯回环进行候选切换时设置标志位（RFC3550)。

# 11.2 接收媒体数据
ICE实现时必须在每个组件上准备好接受媒体数据，当有任意候选在组件最近的请求/响应交换中提供时。（对于RTP来说，就是RTP和RTCP两者，当都提供了候选时）。

当端点从一个媒体流上的新的源或目的地址收到RTP包时，建议应该重新计算抖动缓冲。

RFC3550的8.2小节描述了一个用来检查同步源(SSRC)冲突和循环的算法。这个算法是建立在观察到同样的SSRC来自不同的源传输地址。而在ICE下，这种变化可能在媒体流切换候选
时发生。端点能够确定一个从同一对端产生的媒体流是媒体通讯处理的STUN交换的后续结果。因此，如果发生了源传输地址的改变但是数据包是来自同一个对端端点，这不应该被认识
是SSRC冲突。





























 




