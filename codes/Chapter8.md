# 8 结束ICE流程
------
本章描述端点是如何结束ICE流程的。

# 8.1 完全实现的流程
结束ICE处理需要实现控制端点的候选对提名和状态机的更新。

# 8.1.1 提名候选对
控制端点提名候选对有两个策略：普通提名和激进提名。如果对端是简化实现，端点必须使用普通提名算法。如果对端使用了某个ICE选项(对端的ice-options中表现)而本端点
不能支持，端点也必须使用普通提名。如果对端是完全实现，并且没有使用ICE选项，或是使用了本端点了解的ICE选线，那么普通提名和激进提名都可以使用。一般建议下，
都使用普通提名，因为它具有更好的稳定性。

# 8.1.1.1 普通提名
普通提名时，端点会让一些检查都完成，获取多个USE-CANDIDATE属性。这样，对于媒体的一个组件就可能有多个候选对在有效候选列表中。端点在某个停止准则前不会停止连接
检查，并且会在有效候选中按照评估准则来选择候选对。停止准许和评估准则完全是一种本地优化算法。

当控制端点选择了有效对后，它会重复生成了这个有效对的检查(通过把这个对放到触发检查列表中)，但是会携带USE-CANDIDATE属性。这个检查会成功，促使提名标记有效并
只有这个对有效。接下来，每个组件下的有效列表里就只会有一个候选对，检查列表的状态也设置为了completed, 这个选中的候选对就会被这个组件用来收发媒体数据。

普通提名提供了最大的灵活性，因为端点可以控制停止准则和评估选择准则。唯一个要求就是端点需要选择一个，并只能选择一个有效对作为最终结果并为这个对发送一个带有
USE-CANDIDATE属性的检查。普通提名也会提供ICE的恢复能力在实现上（小节14）。普通提名也更加稳定，因为两个端点会在一个候选对上进行数据传输而不是像激进提名
中在一个暂时的候选上。普通提名的缺点就是会增加延迟，因为它需要完成一些额外的检查。

# 8.1.1.2 激进提名
在激进提名下，控制端点的每一个发出的检查都会携带USE-CANDIDATE属性。当有了第一个成功的检查，这个候选对就会被加入到有效列表中并设置提名标记。当所有的组件都有了
有效候选对在有效列表中后，媒体流开始使用最高优先级的提名候选对。因为这个模式下每个检查都有USE-CANDIDATE属性，有可能一个检查完成的时候另外一个检查已经完成了，
这样带有提名标记的候选对就有多个。ICE通常是在提名候选对中选择优先级最高的那一个。因此，当ICE不断完成连接时，选择候选对可能发生变化，导致数据传输选择改变知道
稳定之前。

# 8.1.2 更新状态
对于控制端点和被控制端点，ICE处理的状态都要依赖提名候选对在有效列表里的生成和检查列表的状态。注意，在任何时刻，下面的一个或多个情况都可能出现：
+ 如果媒体流中有效列表没有提名候选对，而且检查列表的状态是Running, 则ICE处理还将继续进行。

+ 一个媒体流的有效列表有至少一个提名候选对，而检查列表的状态是Running,
    + 端点必须移除同一组件下检查列表和触发检查队列中所有Waiting和Frozen的候选对。
    + 如果组件的检查列表中有In-Progress的候选对，而如果它的优先级低于提名候选对中的最低的优先级，那么端点应该停止该候选对上的检查重试。

+ 如果一个媒体流的所有组件的有效列表里都至少有一个提名候选对，并且检查列表是Running
    + 这个媒体流的检查列表状态应修改为Completed.
    + 端点必须继续处理该媒体流上收到的检查，如果有必要的必须产生触发检查处理(小节7.2)。
    + 端点必须继续重试检查列表中的In-Progress检查。
    + 端点可以在这个媒体流上开始传输媒体数据(小节11.1)。

+ 如果所有的检查列表都是Completed:
    + 端点需要设置ICE的处理全部到Completed.
    + 如果端点是控制端点，它检查所有媒体流下所有组件的最高优先级的提名候选对。如果这个对和最近请求/响应消息中默认候选对不同，控制端点需要生成更新请求(章节9)。
    如果控制端点使用了激进提名算法，这里可能会发出很多更新消息，因为激进提名会导致候选对提名的变更。端点应该稍微延迟发送这个更新(建议是1秒), 以等待提名候选
    对选择的稳定。

+ 如果检查列表是Failed, ICE无法为这个媒体流完成处理。那么其他的媒体流的正确行为应该是：
    + 如果所有的检查列表都是Failed, ICE处理应该都确认为Failed状态，端点应该认为通讯会话是失败的，不应该再重启ICE，并且控制端点应该结束掉整个会话。
    + 如果至少有一个其他媒体流的检查列表是完成的，控制端点应该移除掉所有失败的媒体流在它的更新消息中
    + 如果其他的媒体流检查列表都不是Complete, 但至少有一个是Running，则ICE应该继续尝试下去。

# 8.2 简化实现的流程
简化流程的结束是非常简单直接的。有两种情况考虑：本端点是简化，对端是完全实现 / 本端点是简化实现，对端也是。
ICE的结束可以让端点释放所有分配的没有被ICE使用的本地候选，小节8.3

# 8.2.1 对端完全实现
这个情况下，端点会收到对端的连接检查。当端点在一个媒体流下的所有组件都收到带有USE-CANDIDATE的连接检查时，这个媒体流的ICE状态就从Running切换到Completed.
当所有媒体流都是Completed, ICE处理也进入Completed状态。简化实现从来不会自己判断一个媒体流的ICE流程是否失败，而完全实现端点才会做出决定并且删除或是重新开始
失败的媒体流在后续的请求中。

# 8.2.2 对端简化实现
当请求/响应的交换完成后，双方节点都检查他们的候选和对方的候选。对每一个媒体流，端点都要把他们的本地候选和对端候选进行配对。两个候选在相同组件下，使用同样的
传输协议和使用同样的协议族会导致他们被配对。
+ 如果每个组件只有一个配对的候选对，这个候选对就添加到有效列表中。如果这个媒体流下所有的组件都带有一个候选对了，则这个媒体流的ICE处理进入Completed状态。
  如果所有的媒体流都Completed, ICE的整个状态就设置为Completed. 这通常只会发生在IPv4实现下。

+ 如果每个组件不止一个配对候选对:
    + 端点必须选择一个，按照本地策略。这一般是在IPv6下，所以建议参照RFC3484来选择。
    + 端点把选择的对加入到有效列表中。如小节11.1， 这会允许媒体流开始传输。但是，很有可能的是双方选择了不同的候选对。
    + 为了协调这种冲突，控制端点会发送一个更新请求，包含remote-candidate属性(9.1.3小节)。
    + 在请求发送后，端点不能更新ICE处理的状态。如果接下来这个请求完成了，控制端点必须把所有媒体流和整个ICE处理都设置为Completed.而被控制端点的设置流程
     参照小节9.2.3.

# 8.3 清理候选
# 8.3.1 完全实现流程
章节8的流程要求端点继续监听STUN请求，基础生成媒体流的触发检查，即使这个媒体流的处理已经完成。本小节定义了何时可以安全的结束那些没有被ICE选择的候选上的
检查收发，和释放这些候选。

当ICE用来做SIP，一个请求会分发到多个接收者，ICE会并行处理并独立响应，这些都是使用同一个本地候选。当ICE处理对于媒体流下所有对应端点都已经完成，ICE需要等待
额外的3秒，才可以结束响应或生成触发检查在那个本地候选上。这个时候可能会释放那个候选。而服务反射候选从来不会显式释放，这是keep-alive机制在做的。额外3秒的机制
是为了处理激进提名算法下的候选对可能发生的切换，即使在ICE完成后。

# 8.3.2 简化实现流程
简化实现下，端点尽快释放那些没有被ICE选中的候选，只要使用这些候选的所有媒体流完成了和所有对端的ICE处理。



 









