# 12 SIP的用法
------
# 12.1 延迟的指导
ICE需要在端点间一系列的基于STUN的连接检查。这些检查在应答方生成应答时开始，在请求方则是收到应答时开始。这些检查需要时间来完成，所以，被使用的消息的选择就会
影响到用户的延迟感受。有两个延迟数据需要特别关注:post-pickup delay（接通后延迟)和post-dial delay(拨号后延迟). post-pickup delay是指当用户响应了一个请求后到可以开始投递数据
给请求方的时间。post-dial delay指用户输入目标地址到目标响应成功的时间。
可以分析下面两种情况：一个是初始化邀请中的请求，一个是初始化邀请的响应。

# 12.1.1 邀请中的请求
要减少拨号后延迟，一个推荐就是调用者应该在收到请求后就立即收集候选地址并在完成后生成一个回应的临时响应。ICE要求一个带有SDP的临时响应被可靠的传输。这可以通过存在
的临时响应应答机制(RFC3262)或ICE的一个优化准则来实现。在这个优化准则下，包含SDP应答的临时响应以开始一个或多个媒体流ICE处理可以被可靠的送出，在没有RFC3262的
情况下。要这样做的话, 端点需要在RFC3262中定义的指数补偿定时器下重传临时响应。重传在SDP中的一个媒体流收到STUN绑定请求时，或传输了2xx响应时必须被停止。
如果对端是简化实现，则不会有STUN绑定请求。这时端点必须停止重传18x在发送了4次之后(ICE实际上在没有收到18x时也能正常工作, 但是，经验是发送18x对中间盒子和防火墙
穿越非常重要)。如果在最后重传前没有收到绑定请求，端点不会认为会话结束了。不管临时响应是否被可靠的投递，端点发送更新请求或应答的规则RFC3262不会被改变。特别地，
如果邀请中包含了一个请求，则同样的应答应该出现在所有的1xx和2xx邀请响应中。只有在2xx被发送后，才会有更新请求/应答发生。这个优化在双方端点都支持PRACK时就不应
被使用了。要注意此优化是针对携带开始ICE处理回应的临时响应，而不是一个对应1xx可靠性的技术。

还有一种可能的，就是端点会延迟发送回答知道200 OK消息，显然这会导致很差的用户体验，不推荐。

当响应发送后，端点应该开始它的连接性检查。当媒体流的每个组件中的有效列表一旦有了候选对，则响应方能开始在这个媒体流上发送数据。

然后，在这之前，任何到调用方的数据(例如SIP早期数据 RFC3960)不能被传输。因为这个原因，实现上应该延迟提示调用者，知道有效列表中有有效候选对。在PSTN网关的情况
下，这表示PSTN设置消息应该被延迟。这样做会增加拨号后延迟，但是会有效的排除“幽灵会话"。“幽灵会话”是指接受者收到了会话呼叫，接受了呼叫，但是没有任何数据收到。
这个技术不需要任何其他的支持或前置条件(RFC3312), 因为这是一个本地决策。这也对保证单个数据包不被分割十分有效，这样接通后延迟就为0.如果端点选择了按这个方式延迟
本地通知，它应该在通知开始时生成一个180响应。

# 12.1.2 响应中的请求
除了在邀请中含有请求，和用临时响应和200 OK响应来回答之外，ICE也能实现在回复中含有请求。这种情况下，一般是第三方请求控制(RFC3725)，ICE端点应该生成他们的请求在一个可靠
的临时响应中(RFC3262),并且不应该提示用户收到了邀请。这个回复会在一个 PRACK 中到达。这样允许ICE处理在通知之前进行，这样就没有接通后延迟，只是会增加会话呼叫
创建的延迟。当ICE完成时, 被调用者可以通知用户然后在回复时生成200 OK。 200 OK消息可以不包含SDP，因为请求/响应消息交换已完成。

同时，端点可能在一个 2xx 中包含请求(这种情况是响应在ACK中)。这种情况下，被调用者会在收到邀请时就通知用户，而ICE交换会在用户回复后立即开始。这样会减少会话创建
的延迟，但是会大量增加接通后延迟和数据剪裁。

# 12.2 SIP设置标记和媒体功能标记
RFC5768标准提供了一个SIP设置标记和媒体功能标记给ICE使用。ICE用于SIP的实现应该支持这个标准，使用一个功能标记在注册时可以帮助促进信号交换的操作性。

# 12.3 与分叉的交互
(```)
...
(```)
# 12.4 与预处理的交互
(```)
...
(```)
# 12.5 与第三方呼叫控制的交互
(```)
...
(```)
























 




